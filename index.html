<html>

<head>
    <title>
        COVID19 - Confirmed, Death, Recovery Data by Country
    </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Rubik:400,500,700&display=swap" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://typeiii.github.io/jquery-csv/src/jquery.csv.js"></script>

    <style>
        body {
            background-color: #111;
            font-family: 'Rubik', sans-serif;
        }

         span, h1,h2,h3 {
            color: #FF69EA;
            font-family: 'Rubik', sans-serif;
        }

        h2, h3, h4 {
            font-weight: 400;
        }

        p, ul, li {
            color: #aaa;
            font-size: 18px;
        }

        a, a:link, a:hover, a:visited, a:active {
            color: #FF69EA;
        }

        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        .chart-container {
            width: 900px;
            max-width: 900px;
            margin-left: 40px;
            margin-right: 40px;
            margin-bottom: 40px;
        }
        .my-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
        }

        .header-container {
            width: 900px;
            max-width: 900px;
            margin-left: 40px;
            margin-right: 40px;
            margin-bottom: 40px;
        }

        .chartjs-tooltip {
			opacity: 1;
			position: absolute;
			background: rgba(255, 0, 0, .7);
			color: white;
			border-radius: 3px;
			-webkit-transition: all .1s ease;
			transition: all .1s ease;
			pointer-events: none;
			-webkit-transform: translate(-50%, 0);
			transform: translate(-50%, 0);
			padding: 4px;
		}

		.chartjs-tooltip-key {
			display: inline-block;
			width: 10px;
			height: 10px;
		}
    </style>

</head>

<body>
    
    <div class="main-container">
        <div class="header-container">
            <h1>COVID-19 Cases</h1>
            <h2>
                <span id="startDate"></span> through <span id="endDate"></span> 
            </h2>
            <h3>
                China, Italy, Iran, Korea, 
                South, Spain, Germany, France, Switzerland, Norway, 
                Sweden, Netherlands, Denmark, United Kingdom, Japan, Cruise Ship, US
            </h3>
            <p>
                All legends (confirmed, deaths and recovered) sorted from greatest to least.
                <br>
                These countries were hand-picked by the largest number of cases. Further work
                should be done to dynamically update this list based on large day-to-day differences, 
                top 10 confirmed case rates, or any other valuable metric.
            </p>
            <p>
                <a href="#changelog">Change Log</a>
            </p>
        </div>
    </div>
    
    <div class="my-container">
        

    </div>
    <!-- <div class="chartjs-tooltip" id="tooltip-0"></div> -->
    
    <footer>
       
        <p>
            US Country Data refreshed from CSSE at Johns Hopkins University
            <br>
            <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series" target="_blank">https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series</a>
        </p>
        <p>
            
            Texas Data From: Texas Department of Health and Human Services
            <br>
            <a href="https://dshs.texas.gov/news/updates.shtm#coronavirus" target="_blank">https://dshs.texas.gov/news/updates.shtm#coronavirus</a>
            <br>
            Texas Data Archived and Refreshed from: https://github.com/odessacoding/odessacoding.github.io/blob/master/data-sources/texas-dshs-county-confirmed.csv
            <br>
            <a href="https://github.com/odessacoding/odessacoding.github.io/blob/master/data-sources/texas-dshs-county-confirmed.csv" target="_blank">https://github.com/odessacoding/odessacoding.github.io/blob/master/data-sources/texas-dshs-county-confirmed.csv</a>
        </p>

        <h2 id="changelog">Changelog</h2>
        <h3>March 22, 2020</h3>
        <ul>
            <li>Added Texas Confirmed COVID-19 Data</li>
        </ul>
    </footer>
</body>
<script>

    var globalColors = [
        'rgba(180, 50, 91, .7)',
        'rgba(280, 150, 191, .7)',
        'rgba(80, 150, 91, .7)',
        'rgba(30, 50, 91, .7)',
        'rgba(55, 50, 231, .7)',
        'rgba(180, 250, 241, .7)',
        'rgba(250, 250, 20, .7)',
        'rgba(180, 0, 91, .7)',
        'rgba(180, 50, 0, .7)',
        'rgba(55, 55, 55, .7)',
        'rgba(100, 100, 100, .7)',
        'rgba(250, 150, 91, .7)',
        'rgba(280, 50, 250, .7)',
        'rgba(75, 50, 75, .7)',
        'rgba(50, 255, 111, .7)',
        'rgba(220, 255, 91, .7)',
    ];

    function renderDates() {
        startDate = new Date(dateLabels[0]);
        endDate = new Date(dateLabels[dateLabels.length - 1])
        $('#startDate').text(startDate.getMonth()+1 + "-" + startDate.getDate() + "-" + startDate.getFullYear() );
        $('#endDate').text(endDate.getMonth()+1 + "-" + endDate.getDate() + "-" +  endDate.getFullYear());
    }

    function getAllCountryDatasets(confirmedCases, deathCases, recoveredCases) {
        var dataSets = {}
        for (var key in confirmedCases) {
            if (confirmedCases.hasOwnProperty(key)) {
                var confirmObject = {
                    label: 'Confirmed',
                    backgroundColor: 'rgba(255,232,41,.7)',
                    borderColor: 'rgba(200,181,16,.9)',
                    borderWidth: 2,
                    data: confirmedCases[key]
                };

                var deathObject = {
                    label:  'Deaths',
                    backgroundColor: 'rgba(207,50,91,.6)',
                    borderColor: 'rgba(176,57,88,.9)',
                    borderWidth: 2,
                    data: deathCases[key]
                };

                var recoveredObject = {
                    label:  'Recovered',
                    backgroundColor: 'rgba(50,207,172, .8)',
                    borderColor: 'rgba(51,152,129,.9)',
                    borderWidth: 2,
                    data: recoveredCases[key]
                };
                dataSets[key] = {
                    recovered: recoveredObject,
                    deaths: deathObject,
                    confirmed: confirmObject
                }
            }
        }
        return dataSets;
    }

    

    function getSpecificCountryDatasets(confirmedCases, deathCases, recoveredCases, targetCountries) {
        var dataSets = {}
        for (var key in confirmedCases) {
            if (confirmedCases.hasOwnProperty(key) && targetCountries.indexOf(key) > -1) {
                var confirmObject = {
                    label: 'Confirmed',
                    backgroundColor: 'rgba(255,232,41,.7)',
                    borderColor: 'rgba(200,181,16,.9)',
                    borderWidth: 2,
                    data: confirmedCases[key]
                };

                var deathObject = {
                    label:  'Deaths',
                    backgroundColor: 'rgba(207,50,91,.6)',
                    borderColor: 'rgba(176,57,88,.9)',
                    borderWidth: 2,
                    data: deathCases[key]
                };

                var recoveredObject = {
                    label:  'Recovered',
                    backgroundColor: 'rgba(50,207,172, .8)',
                    borderColor: 'rgba(51,152,129,.9)',
                    borderWidth: 2,
                    data: recoveredCases[key]
                };
                dataSets[key] = {
                    recovered: recoveredObject,
                    deaths: deathObject,
                    confirmed: confirmObject
                }
            }
        }
        return dataSets;
    }

    function generateShadesOfColor(r,g,b,a,color,levels){
        var colors = [];
        var comma = ',';

        for(var i = 0; i < levels; ++i) {
            if(color === 'red') {
                colors.push('rgba(' + (r+i*10) + comma + (g+i*5) + comma + (b-i*10) + comma + a + ')');
            } else if(color === 'green') {
                colors.push('rgba(' + (r-i*20) + comma + (g+i*10) + comma + (b-i*5) + comma + a + ')');
            } else if(color === 'blue') {
                colors.push('rgba(' + (r+i*5) + comma + (g-i*10) + comma + (b+i-10) + comma + a + ')');
            }
        }
        
        return colors;
        
    }

    function getSpecificCountryDatasetsNormalized(confirmedCases, deathCases, recoveredCases, targetCountries) {
        var dataSets = {
            'confirmed': [],
            'deaths': [],
            'recovered': [],
        }

        var shadesOfRed = generateShadesOfColor(180,50,91,.7, 'red', targetCountries.length);
        var shadesOfGreen = generateShadesOfColor(50,150,172, .8, 'green', targetCountries.length);
        var shadesOfBlue = generateShadesOfColor(255,232,150,.7, 'blue', targetCountries.length);
        var colors = [
            'rgba(180, 50, 91, .7)',
            'rgba(280, 150, 191, .7)',
            'rgba(80, 150, 91, .7)',
            'rgba(30, 50, 91, .7)',
            'rgba(55, 50, 231, .7)',
            'rgba(180, 250, 241, .7)',
            'rgba(250, 250, 20, .7)',
            'rgba(180, 0, 91, .7)',
            'rgba(180, 50, 0, .7)',
            'rgba(55, 55, 55, .7)',
            'rgba(100, 100, 100, .7)',
            'rgba(250, 150, 91, .7)',
            'rgba(280, 50, 250, .7)',
            'rgba(75, 50, 75, .7)',
            'rgba(50, 255, 111, .7)',
            'rgba(220, 255, 91, .7)',
        ]

        var index = 0;
        for (var key in confirmedCases) {
            if (confirmedCases.hasOwnProperty(key) && targetCountries.indexOf(key) > -1) {
                var confirmObject = {
                    label: key,
                    backgroundColor: colors[index],
                    fill: false,
                    borderColor: colors[index],
                    pointRadius: 3,
                    borderWidth: 1,
                    data: confirmedCases[key]
                };

                var deathObject = {
                    label: key,
                    backgroundColor: colors[index],
                    fill: false,
                    borderColor: colors[index],
                    pointRadius: 3,
                    borderWidth: 1,
                    data: deathCases[key]
                };

                var recoveredObject = {
                    label: key,
                    backgroundColor: colors[index],
                    fill: false,
                    borderColor: colors[index],
                    pointRadius: 3,
                    borderWidth: 1,
                    data: recoveredCases[key]
                };
                
                dataSets.confirmed.push(confirmObject);
                dataSets.deaths.push(deathObject);
                dataSets.recovered.push(recoveredObject);
                index++;
            }
        }

        dataSets.confirmed.sort(function(a,b){ 
            return b.data[b.data.length-1] - a.data[a.data.length-1];
        });

        dataSets.deaths.sort(function(a,b){ 
            return b.data[b.data.length-1] - a.data[a.data.length-1];
        });

        dataSets.recovered.sort(function(a,b){ 
            return b.data[b.data.length-1] - a.data[a.data.length-1];
        });

        return dataSets;
    }

    function drawMyChart(confirmedCases, deathCases, recoveredCases) {

        drawCountryComparisonCharts(confirmedCases, deathCases, recoveredCases);
        
        drawTexasCharts(texasConfirmed, texasCountiesConfirmed);
    }

    function drawTexasCharts(texasConfirmed, texasCountiesConfirmed) {
        var container = document.querySelector('.my-container');
        Chart.defaults.global.defaultFontSize = 22;
        
        var div = document.createElement('div');
        div.classList.add('chart-container');

        var canvas = document.createElement('canvas');

        var h2 = document.createElement('h2');
        h2.innerHTML = 'Texas Confirmed Cases';
        
        div.appendChild(h2);
        div.appendChild(canvas);
        container.appendChild(div);

        var ctx = canvas.getContext('2d');

        var myData = {
            labels: texasConfirmed['dates'],
            datasets: [{
                label: 'Texas Confirmed',
                data: texasConfirmed['datasets'],
                backgroundColor: globalColors[0],
                fill: false,
                borderColor: globalColors[0],
                pointRadius: 3,
                borderWidth: 1,
            }]
        };

        new Chart(ctx, {
            
            type: 'line',

            // The data for our dataset
            data: myData,

            // Configuration options go here
            options: { 
                responsive: true,
                layout: {
                    
                },
                legend: {
                    position: "top",
                    align: "center",
                    labels: {
                        fontSize: 22,
                        
                    },
                    
                },
                tooltips: {
                    //mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(tooltipItem, data) {
                            var label = data.datasets[tooltipItem.datasetIndex].label || '';
                            var value = data.datasets[tooltipItem.datasetIndex].data;
                            return label + ": " + tooltipItem.yLabel.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        },
                    //     // Use the footer callback to display the sum of the items showing in the tooltip
                    //     footer: function(tooltipItems, data) {
                    //         var sum = 0;

                    //         tooltipItems.forEach(function(tooltipItem) {
                    //             //sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                    //         });
                    //         return 'Sum: ' + sum;
                    //     }
                    // },
                    // footerFontStyle: 'normal',
                    // custom: function(ttModel) {
                    //     console.log(ttModel);
                    }
                    
                },
                hover: {
                    // mode: 'index',
                    intersect: true
                },
                scales: {
                    yAxes: [{
                        display: true,
                        position: 'right',
                        scaleLabel: {
                            show: true,
                            labelString: '#'
                        },
                        gridLines: {
                            drawBorder: false,
                            color: 'rgba(85,85,85, .4)'
                        },
                        ticks: {
                            padding: 10,
                            
                            callback: function(value, index, values) {
                                return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            }
                        }
                    }
                    ],
                    xAxes: [{
                        display: true,
                        ticks: {
                            
                        },
                        scaleLabel: {
                            show: true,
                            labelString: 'Day'
                        },
                        gridLines: {
                            drawBorder: false,
                            color: 'rgba(85,85,85, .2)'
                        }
                    }]
                }
            }

        });
    }

    function drawCountryComparisonCharts(confirmedCases, deathCases, recoveredCases) {
        specifiedCountries = [
            'US', 'Italy', 'China', 'Iran','Korea, South',
            'Spain','Germany','France','Switzerland','Norway','Sweden',
            'Netherlands','Denmark','United Kingdom','Japan','Cruise Ship'
        ]
        allDataSets = getSpecificCountryDatasetsNormalized(confirmedCases, deathCases, recoveredCases, specifiedCountries);

        var container = document.querySelector('.my-container');
        Chart.defaults.global.defaultFontSize = 22;
        // Chart.defaults.global.legend.align = 'start';
        

        for (var key in allDataSets) {
            var div = document.createElement('div');
            div.classList.add('chart-container');

            var canvas = document.createElement('canvas');

            var h2 = document.createElement('h2');
            h2.innerHTML = key;
            
            div.appendChild(h2);
            div.appendChild(canvas);
            container.appendChild(div);

            var ctx = canvas.getContext('2d');

            var myData = {
                    labels: dateLabels,
                    datasets: allDataSets[key]
                };
            
            new Chart(ctx, {
                
                type: 'line',

                // The data for our dataset
                data: myData,

                // Configuration options go here
                options: { 
                    responsive: true,
                    layout: {
                       
                    },
                    legend: {
                        position: "top",
                        align: "center",
                        labels: {
                            fontSize: 22,
                            
                        },
                        
                    },
                    tooltips: {
                        //mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(tooltipItem, data) {
                                var label = data.datasets[tooltipItem.datasetIndex].label || '';
                                var value = data.datasets[tooltipItem.datasetIndex].data;
                                return label + ": " + tooltipItem.yLabel.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            },
                        //     // Use the footer callback to display the sum of the items showing in the tooltip
                        //     footer: function(tooltipItems, data) {
                        //         var sum = 0;

                        //         tooltipItems.forEach(function(tooltipItem) {
                        //             //sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                        //         });
                        //         return 'Sum: ' + sum;
                        //     }
                        // },
                        // footerFontStyle: 'normal',
                        // custom: function(ttModel) {
                        //     console.log(ttModel);
                        }
                        
                    },
                    hover: {
                        // mode: 'index',
                        intersect: true
                    },
                    scales: {
                        yAxes: [{
                            display: true,
                            position: 'right',
                            scaleLabel: {
                                show: true,
                                labelString: '#'
                            },
                            gridLines: {
                                drawBorder: false,
                                color: 'rgba(85,85,85, .4)'
                            },
                            ticks: {
                                padding: 10,
                                
                                callback: function(value, index, values) {
                                    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                                }
                            }
                        }
                        ],
                        xAxes: [{
                            display: true,
                            ticks: {
                                
                            },
                            scaleLabel: {
                                show: true,
                                labelString: 'Day'
                            },
                            gridLines: {
                                drawBorder: false,
                                color: 'rgba(85,85,85, .2)'
                            }
                        }]
                    }
                }

            });
        }
    }

    var confirmedDataFromGithub = '';
    var dateLabels;

    var confirmedCases;
    var fatalityCases;
    var recoveredCases;

    var texasConfirmed;
    var texasCountiesConfirmed;

    $(document).ready(function () {
        $.when(
            $.ajax({
                type: "GET",
                url: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv",
                dataType: "text",
                success: function (data) {
                    confirmedDataFromGithub = data;
                    dateLabels = getListOfDates(confirmedDataFromGithub);
                    confirmedCases = getTotalsByCountryFromCSV(data);
                }
            }),
            $.ajax({
                type: "GET",
                url: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv",
                dataType: "text",
                success: function (data) {
                    deathDataFromGithub = data;
                    fatalityCases = getTotalsByCountryFromCSV(data);
                }
            }),
            $.ajax({
                type: "GET",
                url: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv",
                dataType: "text",
                success: function (data) {
                    confirmedDataFromGithub = data;
                    recoveredCases = getTotalsByCountryFromCSV(data);
                }
            }),
            $.ajax({
                type: "GET",
                url: "https://raw.githubusercontent.com/odessacoding/odessacoding.github.io/master/data-sources/texas-dshs-county-confirmed.csv",
                dataType: "text",
                success: function (data) {
                    texasConfirmed = getTexasConfirmedByDate(data);
                    texasCountiesConfirmed = getTexasConfirmedByCountyAndDate(data);
                }
            })

        ).then(function () {
            drawMyChart(confirmedCases, fatalityCases, recoveredCases);
            renderDates();
        })

        function getTexasConfirmedByDate(data) {
            countyData = getTexasConfirmedByCountyAndDate(data);
            texasConfirmedObject = {}
            runningTotals = new Array(countyData['dates'].length).fill(0);
            for(var key in countyData.datasets) {
                confirmedList = countyData.datasets[key];
                for(var j = 0; j < confirmedList.length; ++j) {
                    runningTotals[j] += confirmedList[j];
                }
            }
            
            texasConfirmedObject['dates'] = countyData['dates'];
            texasConfirmedObject['datasets'] = runningTotals;
            return texasConfirmedObject;
        }

        function getTexasConfirmedByCountyAndDate(data) {
            var result = $.csv.toArrays(data);
            var headers = result[0];
            result=result.slice(1)
            var res = {}
            res['headers'] = headers;
            res['dates'] = []
            res['counties'] = []
            // acquire unique dates and counties
            for(var i = 0; i < result.length; ++i) {
                date = result[i][2];
                county = result[i][0];
                
                if(res['dates'].indexOf(date) < 0 ) { res['dates'].push(date); }
                if(res['counties'].indexOf(county) < 0) { res['counties'].push(county); }
            }
            res['counties'].sort();
            
            // Create County Table
            countyData = {}
            for( var j = 0; j < res['counties'].length; ++j) {
                if( !countyData.hasOwnProperty(res['counties'][j]) ) {
                    countyData[res['counties'][j]] = new Array(res['dates'].length).fill(0);
                }
            }

            // Hydreate County table
            for(var i = 0; i < result.length; ++i) {
                date = result[i][2];
                county = result[i][0];
                cases = result[i][1]
                if( countyData.hasOwnProperty(county) && res['dates'].indexOf(date) > -1) { 
                    countyData[county][res['dates'].indexOf(date)] = parseInt(cases);
                } else {
                    console.error('Could not hydrate TX County Point:' + county + ' ' + date);
                }
            }

           res['datasets'] = countyData;
           return res;
           
        }


        function getListOfDates(muhData) {
            var result = $.csv.toArrays(muhData);
            var headers = result[0]; // this gets us the first row (aka the headers)
            var dateLabels = headers.slice(4)
            return dateLabels;
        }

        function getSingleRowByCountryName(muhData, nameOfTheCountry) {
            var result = $.csv.toArrays(muhData); // an array of arrays (or list of lists)

            for (var currentListPosition = 0; currentListPosition < result.length; currentListPosition++) {
                var theListImLookingAt = result[currentListPosition];
                if (theListImLookingAt[1] == nameOfTheCountry) {
                    slicedData = theListImLookingAt.slice(4)
                    return slicedData;
                }
            }
        }

        function getTotalsByCountryName(muhData, nameOfTheCountry) {
            var result = muhData;

            var runningTotal = new Array(result[0].length - 4).fill(0);

            for (var currentListPosition = 0; currentListPosition < result.length; currentListPosition++) {
                var theListImLookingAt = result[currentListPosition];
                if (theListImLookingAt[1] == nameOfTheCountry) {
                    slicedData = theListImLookingAt.slice(4)
                    for (var currentColumnIndex = 0; currentColumnIndex < slicedData.length; currentColumnIndex++) {
                        runningTotal[currentColumnIndex] = runningTotal[currentColumnIndex] + parseInt(slicedData[currentColumnIndex])
                    }
                }
            }
            
            return runningTotal;
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        function getUniqueListOfCountries(muhData) {
            var result = muhData;
            var countries = [];
            var uniqueListOfCountries = [];

            for (var currentListPosition = 0; currentListPosition < result.length; currentListPosition++) {
                var theListImLookingAt = result[currentListPosition];
                countries.push(theListImLookingAt[1]);
            }

            uniqueListOfCountries = countries.filter(onlyUnique);
            uniqueListOfCountries = uniqueListOfCountries.slice(1);
            uniqueListOfCountries.sort();
            return uniqueListOfCountries;
        }

        function getTotalsByCountryFromCSV(muhData) {

            var csvData = $.csv.toArrays(muhData); // an array of arrays (or list of lists)

            var uniqueCountries = getUniqueListOfCountries(csvData);

            var countryData = {};

            for (var index = 0; index < uniqueCountries.length; index++) {
                var nameOfCurrentCountry = uniqueCountries[index];
                var totalForThisCountry = getTotalsByCountryName(csvData, nameOfCurrentCountry);

                countryData[nameOfCurrentCountry] = totalForThisCountry;
            }

            return countryData;

        }

    });

</script>

</html>